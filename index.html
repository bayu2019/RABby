<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAB Bayu Permana Putra</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 0;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 3px solid #34495e;
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a, #2c3e50, #34495e);
            color: #ecf0f1;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #e67e22;
            position: relative;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e67e22, #f39c12, #e67e22);
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-left .icon { font-size: 2.5em; color: #e67e22; }
        .header-left h1 {
            font-size: 2.2em; font-weight: 700; text-transform: uppercase;
            letter-spacing: 2px; color: #ecf0f1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .header-left p { font-size: 0.9em; color: #bdc3c7; margin-top: 5px; font-weight: 300; }
        .header-right { text-align: right; }
        .save-status {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #27ae60;
            color: #27ae60;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-bottom: 10px;
            display: inline-block;
        }
        .copyright { font-size: 0.8em; color: #95a5a6; opacity: 0.8; }
        .content { padding: 40px; background: #f8f9fa; }
        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
            background: white;
            padding: 30px;
            border-radius: 0;
            border: 2px solid #34495e;
            border-left: 6px solid #e67e22;
        }
        .info-group { position: relative; }
        .info-group label {
            display: block;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        .info-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 0;
            font-size: 16px;
            transition: all 0.3s;
            background: #ffffff;
            font-weight: 500;
        }
        .info-group input:focus {
            outline: none;
            border-color: #e67e22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
        }
        .add-item-section {
            background: white;
            padding: 35px;
            border-radius: 0;
            margin-bottom: 35px;
            border: 2px solid #34495e;
            border-left: 6px solid #e67e22;
        }
        .add-item-section h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.4em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .item-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        .item-form input, .item-form select {
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 0;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }
        .item-form input:focus, .item-form select:focus {
            outline: none;
            border-color: #e67e22;
        }
        .add-btn, .save-btn {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 0;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid transparent;
            margin-right: 10px;
        }
        .add-btn:hover, .save-btn:hover {
            background: linear-gradient(135deg, #d35400, #e67e22);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.3);
        }
        .rab-table {
            background: white;
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 35px;
            border: 2px solid #34495e;
        }
        .table-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            padding: 20px;
            border-bottom: 3px solid #e67e22;
        }
        .table-header h3 {
            text-align: center;
            font-size: 1.4em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #34495e;
            color: #ecf0f1;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        td {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #e8f4f8; }
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 0;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .delete-btn:hover { background: #c0392b; }
        .summary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            padding: 35px;
            border-radius: 0;
            margin-bottom: 25px;
            border: 3px solid #e67e22;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        .summary-item {
            text-align: center;
            padding: 20px;
            background: rgba(236, 240, 241, 0.1);
            border-radius: 0;
            border: 1px solid rgba(230, 126, 34, 0.3);
        }
        .summary-item h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #bdc3c7;
        }
        .summary-item .amount {
            font-size: 1.1em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: #e67e22;
        }
        .export-section {
            text-align: center;
            padding: 25px;
            background: white;
            border: 2px solid #4b4e52;
            border-left: 6px solid #e67e22;
        }
        .export-btn {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: #ecf0f1;
            border: none;
            padding: 15px 35px;
            border-radius: 0;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid transparent;
        }
        .export-btn:hover {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 73, 94, 0.3);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        .empty-state i {
            font-size: 4em;
            margin-bottom: 25px;
            opacity: 0.5;
            color: #bdc3c7;
        }
        .auto-save-info {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid #27ae60;
            color: #27ae60;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0;
            font-size: 0.9em;
            text-align: center;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .header-left, .header-right { text-align: center; }
            .item-form { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            th, td { padding: 12px 8px; font-size: 12px; }
            .header-left h1 { font-size: 1.6em; }
            .add-btn, .save-btn { width: 100%; margin-bottom: 10px; }
        }
        .add-save-btns {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            .add-save-btns { flex-direction: column; }
        }
        footer {
            text-align:center;
            color:#95a5a6;
            font-size:0.9em;
            margin-top:40px;
            opacity:0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="icon">‚öôÔ∏è</div>
                <div>
                    <h1>RAB Bayu Permana Putra</h1>
                    <p>Industrial Construction Budget Planning</p>
                </div>
            </div>
            <div class="header-right">
                <div class="save-status" id="saveStatus">üíæ Manual Save</div>
                <div class="copyright">¬© 2025 permana.kp.mjm<br>All Rights Reserved</div>
            </div>
        </div>
        
        <div class="content">
            <div class="auto-save-info">
                <strong>üíæ MANUAL SAVE</strong> - Data hanya tersimpan jika Anda klik tombol <b>SAVE DATA</b> di samping tombol tambah item. Data tidak akan hilang saat refresh/tutup aplikasi jika sudah di-save.
            </div>
            
            <!-- Project Information -->
            <div class="project-info">
                <div class="info-group">
                    <label>Nama Proyek</label>
                    <input type="text" id="projectName" placeholder="Masukkan nama proyek">
                </div>
                <div class="info-group">
                    <label>Lokasi</label>
                    <input type="text" id="projectLocation" placeholder="Masukkan lokasi proyek">
                </div>
                <div class="info-group">
                    <label>Tanggal</label>
                    <input type="date" id="projectDate">
                </div>
                <div class="info-group">
                    <label>PIC/Konsultan</label>
                    <input type="text" id="projectConsultant" placeholder="Nama penanggung jawab">
                </div>
                <div class="info-group">
                    <label>Nama Penyedia</label>
                    <input type="text" id="projectSupplier" placeholder="Nama penyedia barang/jasa">
                </div>
            </div>
            
            <!-- Add Item Section -->
            <div class="add-item-section">
                <h3>‚ö° Tambah Item Pekerjaan</h3>
                <div class="item-form">
                    <input type="text" id="itemDescription" placeholder="Uraian Pekerjaan">
                    <select id="itemUnit">
                        <option value="">Pilih Satuan</option>
                        <option value="m¬≤">m¬≤ (meter persegi)</option>
                        <option value="m¬≥">m¬≥ (meter kubik)</option>
                        <option value="m">m (meter)</option>
                        <option value="buah">buah</option>
                        <option value="set">set</option>
                        <option value="unit">unit</option>
                        <option value="kg">kg (kilogram)</option>
                        <option value="ton">ton</option>
                        <option value="ls">ls (lump sum)</option>
                        <option value="hari">hari</option>
                        <option value="bulan">bulan</option>
                    </select>
                    <input type="number" id="itemVolume" placeholder="Volume" step="0.01">
                    <input type="number" id="itemPrice" placeholder="Harga Satuan (Rp)" step="0.01">
                </div>
                <div class="add-save-btns">
                    <button class="add-btn" onclick="addItem()">‚ö° Tambah Item</button>
                    <button class="save-btn" onclick="saveToStorage()">üíæ Save Data</button>
                </div>
            </div>
            
            <!-- RAB Table -->
            <div class="rab-table">
                <div class="table-header">
                    <h3>üìã Daftar Rencana Anggaran Biaya</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Uraian Pekerjaan</th>
                                <th>Satuan</th>
                                <th>Volume</th>
                                <th>Harga Satuan (Rp)</th>
                                <th>Jumlah Harga (Rp)</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rabTableBody">
                            <tr class="empty-state">
                                <td colspan="7">
                                    <div>
                                        <div style="font-size: 3em; margin-bottom: 15px;">‚öôÔ∏è</div>
                                        <h3>Belum ada item pekerjaan</h3>
                                        <p>Tambahkan item pekerjaan untuk mulai menghitung RAB</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="summary">
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Total Item</h4>
                        <div class="amount" id="totalItems">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>Subtotal</h4>
                        <div class="amount" id="subtotal">Rp 0</div>
                    </div>
                    <div class="summary-item">
                        <h4>PPN 11%</h4>
                        <div class="amount" id="ppn">Rp 0</div>
                    </div>
                    <div class="summary-item">
                        <h4>Total Keseluruhan</h4>
                        <div class="amount" id="grandTotal">Rp 0</div>
                    </div>
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" onclick="exportToExcel()">üìä Export Excel</button>
                <button class="export-btn" onclick="exportToCSV()">üìÑ Export CSV</button>
                <button class="export-btn" onclick="printRAB()">üñ®Ô∏è Print RAB</button>
                <button class="export-btn" onclick="clearAllData()">üóëÔ∏è Clear Data</button>
            </div>
        </div>
    </div>
    <footer>
        ¬© 2025 permana.kp.mjm | All Rights Reserved
    </footer>
    <script>
    let rabItems = [];
    let itemCounter = 0;

    // Format angka ribuan tanpa Rp
    function formatAngka(num) {
        return Number(num).toLocaleString('id-ID');
    }

    function saveToStorage() {
        const data = {
            rabItems: rabItems,
            itemCounter: itemCounter,
            projectInfo: {
                name: document.getElementById('projectName').value,
                location: document.getElementById('projectLocation').value,
                date: document.getElementById('projectDate').value,
                consultant: document.getElementById('projectConsultant').value,
                supplier: document.getElementById('projectSupplier').value
            }
        };

        try {
            const jsonData = JSON.stringify(data);
            const compressedData = btoa(jsonData);
            const chunkSize = 500000; // 500KB per chunk
            const totalChunks = Math.ceil(compressedData.length / chunkSize);

            // Clear existing chunks
            for (let i = 0; i < 50; i++) {
                localStorage.removeItem(`rab_data_chunk_${i}`);
            }

            // Store new chunks
            for (let i = 0; i < totalChunks; i++) {
                const chunk = compressedData.slice(i * chunkSize, (i + 1) * chunkSize);
                localStorage.setItem(`rab_data_chunk_${i}`, chunk);
            }

            localStorage.setItem('rab_total_chunks', totalChunks.toString());
            localStorage.setItem('rab_last_save', new Date().toISOString());

            document.getElementById('saveStatus').textContent = '‚úÖ Data Saved';
            document.getElementById('saveStatus').style.background = 'rgba(46, 204, 113, 0.2)';
            document.getElementById('saveStatus').style.borderColor = '#27ae60';
            document.getElementById('saveStatus').style.color = '#27ae60';
        } catch (error) {
            console.error('Save failed:', error);
            document.getElementById('saveStatus').textContent = '‚ùå Save Failed';
            document.getElementById('saveStatus').style.background = 'rgba(231, 76, 60, 0.2)';
            document.getElementById('saveStatus').style.borderColor = '#e74c3c';
            document.getElementById('saveStatus').style.color = '#e74c3c';
        }
    }

    function loadFromStorage() {
        try {
            const totalChunks = parseInt(localStorage.getItem('rab_total_chunks') || '0');
            if (totalChunks === 0) return;

            let compressedData = '';
            for (let i = 0; i < totalChunks; i++) {
                const chunk = localStorage.getItem(`rab_data_chunk_${i}`) || '';
                compressedData += chunk;
            }

            if (compressedData) {
                const jsonData = atob(compressedData);
                const data = JSON.parse(jsonData);

                rabItems = data.rabItems || [];
                itemCounter = data.itemCounter || 0;

                if (data.projectInfo) {
                    document.getElementById('projectName').value = data.projectInfo.name || '';
                    document.getElementById('projectLocation').value = data.projectInfo.location || '';
                    document.getElementById('projectDate').value = data.projectInfo.date || '';
                    document.getElementById('projectConsultant').value = data.projectInfo.consultant || '';
                    document.getElementById('projectSupplier').value = data.projectInfo.supplier || '';
                }

                updateTable();
                updateSummary();

                const lastSave = localStorage.getItem('rab_last_save');
                if (lastSave) {
                    const saveDate = new Date(lastSave);
                    document.getElementById('saveStatus').textContent = `‚úÖ Loaded: ${saveDate.toLocaleDateString('id-ID')} ${saveDate.toLocaleTimeString('id-ID')}`;
                }
            }
        } catch (error) {
            console.error('Load failed:', error);
        }
    }

    // Set today's date and load data
    document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
    loadFromStorage();

    function formatRupiah(amount) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    function addItem() {
        const description = document.getElementById('itemDescription').value;
        const unit = document.getElementById('itemUnit').value;
        const volume = parseFloat(document.getElementById('itemVolume').value);
        const price = parseFloat(document.getElementById('itemPrice').value);

        if (!description || !unit || !volume || !price) {
            alert('Mohon lengkapi semua field!');
            return;
        }

        const total = volume * price;
        const item = {
            id: ++itemCounter,
            description,
            unit,
            volume,
            price,
            total
        };

        rabItems.push(item);
        updateTable();
        clearForm();
        updateSummary();
    }

    function deleteItem(id) {
        if (confirm('Yakin ingin menghapus item ini?')) {
            rabItems = rabItems.filter(item => item.id !== id);
            updateTable();
            updateSummary();
        }
    }

    function updateTable() {
        const tbody = document.getElementById('rabTableBody');

        if (rabItems.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-state">
                    <td colspan="7">
                        <div>
                            <div style="font-size: 3em; margin-bottom: 15px;">‚öôÔ∏è</div>
                            <h3>Belum ada item pekerjaan</h3>
                            <p>Tambahkan item pekerjaan untuk mulai menghitung RAB</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = rabItems.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item.description}</td>
                <td>${item.unit}</td>
                <td class="number">${item.volume.toLocaleString('id-ID')}</td>
                <td class="number">${formatAngka(item.price)}</td>
                <td class="number"><strong>${formatAngka(item.total)}</strong></td>
                <td>
                    <button class="delete-btn" onclick="deleteItem(${item.id})">Hapus</button>
                </td>
            </tr>
        `).join('');
    }

    function updateSummary() {
        const subtotal = rabItems.reduce((sum, item) => sum + item.total, 0);
        const ppn = subtotal * 0.11;
        const grandTotal = subtotal + ppn;

        function formatAngkaRp(num) {
            return "Rp " + num.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        document.getElementById('totalItems').textContent = rabItems.length;
        document.getElementById('subtotal').textContent = formatAngkaRp(subtotal);
        document.getElementById('ppn').textContent = formatAngkaRp(ppn);
        document.getElementById('grandTotal').textContent = formatAngkaRp(grandTotal);
    }

    function clearForm() {
        document.getElementById('itemDescription').value = '';
        document.getElementById('itemUnit').value = '';
        document.getElementById('itemVolume').value = '';
        document.getElementById('itemPrice').value = '';
    }

    function clearAllData() {
        if (confirm('Yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
            rabItems = [];
            itemCounter = 0;
            document.getElementById('projectName').value = '';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectConsultant').value = '';
            document.getElementById('projectSupplier').value = '';

            updateTable();
            updateSummary();

            // Clear storage
            for (let i = 0; i < 50; i++) {
                localStorage.removeItem(`rab_data_chunk_${i}`);
            }
            localStorage.removeItem('rab_total_chunks');
            localStorage.removeItem('rab_last_save');

            document.getElementById('saveStatus').textContent = 'üóëÔ∏è Data Cleared';
            document.getElementById('saveStatus').style.background = 'rgba(52, 152, 219, 0.2)';
            document.getElementById('saveStatus').style.borderColor = '#3498db';
            document.getElementById('saveStatus').style.color = '#3498db';

            setTimeout(() => {
                document.getElementById('saveStatus').textContent = '‚úÖ Ready';
                document.getElementById('saveStatus').style.background = 'rgba(46, 204, 113, 0.2)';
                document.getElementById('saveStatus').style.borderColor = '#27ae60';
                document.getElementById('saveStatus').style.color = '#27ae60';
            }, 2000);
        }
    }

    // Export ke Excel (.xls agar tidak corrupt) + info proyek & penyedia
    // Export ke Excel (.xls) + rekap subtotal, ppn, total
function exportToExcel() {
    if (rabItems.length === 0) {
        alert('Tidak ada data untuk diekspor!');
        return;
    }

    const name = document.getElementById('projectName').value || '-';
    const location = document.getElementById('projectLocation').value || '-';
    const date = document.getElementById('projectDate').value || '-';
    const consultant = document.getElementById('projectConsultant').value || '-';
    const supplier = document.getElementById('projectSupplier').value || '-';

    let subtotal = rabItems.reduce((sum, item) => sum + item.total, 0);
    let ppn = subtotal * 0.11;
    let grandTotal = subtotal + ppn;

    let table = `
        <table border="1" style="margin-bottom:10px">
            <tr><td><b>Nama Proyek</b></td><td>${name}</td></tr>
            <tr><td><b>Lokasi</b></td><td>${location}</td></tr>
            <tr><td><b>Tanggal</b></td><td>${date}</td></tr>
            <tr><td><b>PIC/Konsultan</b></td><td>${consultant}</td></tr>
            <tr><td><b>Nama Penyedia</b></td><td>${supplier}</td></tr>
        </table>
        <br>
        <table border="1">
            <tr>
                <th>No</th>
                <th>Uraian Pekerjaan</th>
                <th>Satuan</th>
                <th>Volume</th>
                <th>Harga Satuan (Rp)</th>
                <th>Jumlah Harga (Rp)</th>
            </tr>`;
    rabItems.forEach((item, i) => {
        table += `<tr>
            <td>${i + 1}</td>
            <td>${item.description}</td>
            <td>${item.unit}</td>
            <td>${item.volume}</td>
            <td>${formatAngka(item.price)}</td>
            <td>${formatAngka(item.total)}</td>
        </tr>`;
    });
    table += `</table>
    <br>
    <table border="1">
        <tr><td><b>Subtotal</b></td><td>Rp ${subtotal.toLocaleString('id-ID')}</td></tr>
        <tr><td><b>PPN 11%</b></td><td>Rp ${ppn.toLocaleString('id-ID')}</td></tr>
        <tr><td><b>Total Keseluruhan</b></td><td>Rp ${grandTotal.toLocaleString('id-ID')}</td></tr>
    </table>
    <div style="text-align:center; color:#95a5a6; font-size:0.9em; margin-top:40px; opacity:0.8;">
        ¬© 2025 permana.kp.mjm | All Rights Reserved
    </div>`;

    const blob = new Blob([table], { type: "application/vnd.ms-excel" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "RAB.xls";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Export ke CSV + rekap subtotal, ppn, total
function exportToCSV() {
    if (rabItems.length === 0) {
        alert('Tidak ada data untuk diekspor!');
        return;
    }

    let csv = "No,Uraian Pekerjaan,Satuan,Volume,Harga Satuan (Rp),Jumlah Harga (Rp)\n";
    rabItems.forEach((item, i) => {
        csv += `"${i + 1}","${item.description}","${item.unit}","${item.volume}","${item.price}","${item.total}"\n`;
    });

    let subtotal = rabItems.reduce((sum, item) => sum + item.total, 0);
    let ppn = subtotal * 0.11;
    let grandTotal = subtotal + ppn;

    csv += `,,,,,\nSubtotal,,,,,"${subtotal}"\nPPN 11%,,,,,"${ppn}"\nTotal Keseluruhan,,,,,"${grandTotal}"\n`;

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "RAB.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Print RAB + rekap subtotal, ppn, total
function printRAB() {
    const name = document.getElementById('projectName').value || '-';
    const location = document.getElementById('projectLocation').value || '-';
    const date = document.getElementById('projectDate').value || '-';
    const consultant = document.getElementById('projectConsultant').value || '-';
    const supplier = document.getElementById('projectSupplier').value || '-';

    let subtotal = rabItems.reduce((sum, item) => sum + item.total, 0);
    let ppn = subtotal * 0.11;
    let grandTotal = subtotal + ppn;

    let html = `
        <html>
        <head>
            <title>Print RAB</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #222; margin:0; padding-bottom:60px;}
                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                th, td { border: 1px solid #444; padding: 8px; }
                th { background: #eee; }
                h2 { margin-bottom: 10px; }
                .copyright-print {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    text-align: center;
                    color: #95a5a6;
                    font-size: 0.9em;
                    opacity: 0.8;
                    padding: 10px 0 10px 0;
                    background: #fff;
                }
                @media print {
                    body { margin-bottom: 60px !important; }
                    .copyright-print {
                        position: fixed !important;
                        bottom: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        background: #fff !important;
                    }
                }
            </style>
        </head>
        <body>
            <h2>Rencana Anggaran Biaya</h2>
            <table>
                <tr><td><b>Nama Proyek</b></td><td>${name}</td></tr>
                <tr><td><b>Lokasi</b></td><td>${location}</td></tr>
                <tr><td><b>Tanggal</b></td><td>${date}</td></tr>
                <tr><td><b>PIC/Konsultan</b></td><td>${consultant}</td></tr>
                <tr><td><b>Nama Penyedia</b></td><td>${supplier}</td></tr>
            </table>
            <table>
                <tr>
                    <th>No</th>
                    <th>Uraian Pekerjaan</th>
                    <th>Satuan</th>
                    <th>Volume</th>
                    <th>Harga Satuan (Rp)</th>
                    <th>Jumlah Harga (Rp)</th>
                </tr>`;
    rabItems.forEach((item, i) => {
        html += `<tr>
            <td>${i + 1}</td>
            <td>${item.description}</td>
            <td>${item.unit}</td>
            <td>${item.volume}</td>
            <td>${formatAngka(item.price)}</td>
            <td>${formatAngka(item.total)}</td>
        </tr>`;
    });
    html += `</table>
        <table>
            <tr><td><b>Subtotal</b></td><td>Rp ${subtotal.toLocaleString('id-ID')}</td></tr>
            <tr><td><b>PPN 11%</b></td><td>Rp ${ppn.toLocaleString('id-ID')}</td></tr>
            <tr><td><b>Total Keseluruhan</b></td><td>Rp ${grandTotal.toLocaleString('id-ID')}</td></tr>
        </table>
        <div class="copyright-print">
            ¬© 2025 permana.kp.mjm | All Rights Reserved
        </div>
        </body>
        </html>
    `;

    const win = window.open('', '', 'width=900,height=700');
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
    win.close();
}
    
    </script>
</body>
</html>
